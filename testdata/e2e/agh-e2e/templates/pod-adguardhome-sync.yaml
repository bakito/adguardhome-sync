apiVersion: v1
kind: Pod
metadata:
  name: adguardhome-sync
  namespace: {{ $.Release.Namespace }}
spec:
  serviceAccountName: agh-e2e
  initContainers:
    - name: wait-for-others
      image: bitnami/kubectl:1.24
      command:
        - /bin/bash
        - -c
        - |
          #!/bin/bash
          echo "wait for adguardhome pods"
          for pod in $(kubectl get pods -l bakito.net/adguardhome-sync -o name); do
            kubectl wait --for condition=Ready ${pod} --timeout=30s
          done
  containers:
    - name: adguardhome-sync
      image: ghcr.io/bakito/adguardhome-sync:main
      command:
        - /opt/go/adguardhome-sync
        - run
      envFrom:
        - configMapRef:
            name: sync-conf
  restartPolicy: Never
